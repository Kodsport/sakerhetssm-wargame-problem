/*
   Simple intro.
   Global variables since they're faster.

*/

#include <gb/gb.h>
#include <gb/cgb.h>
#include "bg.h"
#include "font.h"
#include "music/gbt_player.h"

uint8_t  sin[256] = {
0x10,0x10,0x11,0x11,0x12,0x12,0x12,0x13,
0x13,0x14,0x14,0x14,0x15,0x15,0x15,0x16,
0x16,0x17,0x17,0x17,0x18,0x18,0x18,0x19,
0x19,0x19,0x1a,0x1a,0x1a,0x1a,0x1b,0x1b,
0x1b,0x1c,0x1c,0x1c,0x1c,0x1d,0x1d,0x1d,
0x1d,0x1e,0x1e,0x1e,0x1e,0x1e,0x1e,0x1f,
0x1f,0x1f,0x1f,0x1f,0x1f,0x1f,0x20,0x20,
0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,
0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,
0x20,0x20,0x1f,0x1f,0x1f,0x1f,0x1f,0x1f,
0x1f,0x1f,0x1e,0x1e,0x1e,0x1e,0x1e,0x1d,
0x1d,0x1d,0x1d,0x1d,0x1c,0x1c,0x1c,0x1b,
0x1b,0x1b,0x1b,0x1a,0x1a,0x1a,0x19,0x19,
0x19,0x18,0x18,0x18,0x17,0x17,0x17,0x16,
0x16,0x16,0x15,0x15,0x14,0x14,0x14,0x13,
0x13,0x13,0x12,0x12,0x11,0x11,0x11,0x10,
0x10,0xf,0xf,0xf,0xe,0xe,0xd,0xd,
0xd,0xc,0xc,0xc,0xb,0xb,0xa,0xa,
0xa,0x9,0x9,0x9,0x8,0x8,0x8,0x7,
0x7,0x7,0x6,0x6,0x6,0x5,0x5,0x5,
0x5,0x4,0x4,0x4,0x3,0x3,0x3,0x3,
0x3,0x2,0x2,0x2,0x2,0x2,0x1,0x1,
0x1,0x1,0x1,0x1,0x1,0x1,0x0,0x0,
0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
0x0,0x0,0x1,0x1,0x1,0x1,0x1,0x1,
0x1,0x2,0x2,0x2,0x2,0x2,0x2,0x3,
0x3,0x3,0x3,0x4,0x4,0x4,0x4,0x5,
0x5,0x5,0x6,0x6,0x6,0x6,0x7,0x7,
0x7,0x8,0x8,0x8,0x9,0x9,0x9,0xa,
0xa,0xb,0xb,0xb,0xc,0xc,0xc,0xd,
0xd,0xe,0xe,0xe,0xf,0xf,0x10,0x10,
};
int text_pos = 152;
const int text_len = 18;
int initial_text[] = {
    'C'-1,
    'R'-1,
    'A'-1,
    'T'-1,
    'E'-1,
    0,
    'C'-1,
    'T'-1,
    'F'-1,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
};
int flag[] = {
    0xe1,
    0xf5,
    0xe5,
    0xf5,
    0xe3,
    0xea,
    0xfa,
    0xef,
    0xf1,
    0xea,
    0xec,
    0xba,
    0x91,
    0xf4,
    0xe4,
    0xf6,
    0xe2,
    0xe8,
};

int i = 0;
uint8_t f = 0;
uint8_t key = 0;
uint8_t currkey = 0;
uint8_t prevkey = 0;
uint8_t input_pos = 0;
uint8_t enc_key = 0;

extern const unsigned char * song_Data[];

void
vblank()
{
    f++;
    text_pos-=1;

    // input
    currkey = joypad();
    if ((currkey & J_A) && !(prevkey & J_A)) {
        enc_key |= (1 << input_pos);
        input_pos++;
        key=1;
    } else if ((currkey & J_B) && !(prevkey & J_B)) {
        enc_key &= ~(1 << input_pos);
        input_pos++;
        key=1;
    } else {
        key=0;
    }
    prevkey = currkey;

    if (key) {
        for (i = 0; i < text_len; i++) {
            set_sprite_tile(i, (flag[i] ^ (enc_key+i)) % 93);
        }
        if (input_pos >= 8) {
            input_pos = 0;
            enc_key = 0;
        }
    }

    gbt_update();
}

void main() {
    disable_interrupts();
    gbt_play(song_Data, 2, 7);
    gbt_loop(1);

    set_interrupts(VBL_IFLAG);
    enable_interrupts();

    set_bkg_data(0, bg_tile_count, bg_tile_data);
    VBK_REG = 1;
    VBK_REG = 0;
    set_bkg_tiles(0, 1, 30, 18, bg_map_data);
    SHOW_BKG;
    DISPLAY_ON;

    // Init sprites
    SPRITES_8x8;
    set_sprite_data(0, 94, font_tile_data);
    for (i = 0; i < text_len; i++) {
        set_sprite_tile(i, initial_text[i]);
    }

    SHOW_SPRITES;
    add_VBL(vblank);
    while (1) {
	    if (LY_REG >= 0 && LY_REG <= 134) {
            SCX_REG = sin[(LY_REG + f) & 0xFF];
	    } else {
	        for (i = 0; i < text_len; i++)
                move_sprite(i, 140, text_pos+i*8);
	    }
    }
}
